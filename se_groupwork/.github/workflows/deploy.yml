name: Django CI/CD Pipeline

on:
  push:
    branches: [ main, master, Develop-backend ]
  pull_request:
    branches: [ main, master, Develop-backend ]
env:
  PROJECT_NAME: se-groupwork

jobs:
  # 代码质量检查
  code-quality:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install flake8 black isort

      - name: Check code formatting with Black
        run: |
          black --check .

      - name: Check import sorting with isort
        run: |
          isort --check-only .

      - name: Lint with flake8
        run: |
          flake8 .

  # 构建和测试
  build-and-test:
    runs-on: ubuntu-latest
    needs: code-quality
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: example
          MYSQL_DATABASE: se
          MYSQL_USER: se
          MYSQL_PASSWORD: example
        options: >-
          --health-cmd="mysqladmin ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3
        ports:
          - 3306:3306

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Create environment file
        run: |
          cat << EOF > .env.ci
          DEBUG=False
          SECRET_KEY=ci-test-key-$(openssl rand -hex 32)
          MYSQL_ROOT_PASSWORD=example
          MYSQL_DATABASE=se
          MYSQL_USER=se
          MYSQL_PASSWORD=example
          MYSQL_HOST=127.0.0.1
          SCHEDULER_TZ=Asia/Shanghai
          EOF

      - name: Wait for MySQL
        run: |
          until nc -z 127.0.0.1 3306; do
            sleep 1
          done

      - name: Run migrations
        run: |
          python manage.py migrate --settings=se_groupwork.settings

      - name: Run tests
        run: |
          python manage.py test --settings=se_groupwork.settings

  # 直接部署到服务器（无需Docker Registry）
  deploy:
    runs-on: ubuntu-latest
    needs: build-and-test
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to server
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            cd /path/to/your/project
            
            # 停止当前服务
            docker-compose down
            
            # 拉取最新代码（如果代码在服务器上通过git管理）
            # git pull origin main
            
            # 重新构建镜像（使用缓存加速）
            docker-compose build --parallel
            
            # 启动所有服务
            docker-compose up -d
            
            # 等待服务启动
            sleep 30
            
            # 执行数据库迁移
            docker-compose exec web python manage.py migrate --noinput
            
            # 收集静态文件
            docker-compose exec web python manage.py collectstatic --noinput
            
            # 重启nginx确保配置生效
            docker-compose restart nginx
            
            echo "部署完成！"
            echo "服务状态："
            docker-compose ps